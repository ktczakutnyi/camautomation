import serial
import time

# --- CONFIGURATION ---
PORT = '/dev/ttyUSB0'  # Change to 'COM3' etc. if on Windows
BAUD = 115200
STEP_MM = 12.7         # 0.5 inches in mm
START_Z = 127.0        # 5 inches in mm
GRID_SIZE = 10         # 10x10

# 1. Connect to Ender 3
try:
    printer = serial.Serial(PORT, BAUD, timeout=1)
    time.sleep(2) # Wait for reboot
    print("Connected to Ender 3")
except:
    print("Failed to connect. Check your Port.")
    exit()

def send_command(cmd):
    printer.write(f"{cmd}\n".encode())
    while True:
        line = printer.readline().decode().strip()
        if line == "ok":
            break

# 2. Initialization
print("Homing and setting height...")
send_command("G28")          # Home all axes
send_command(f"G1 Z{START_Z} F1500") # Move to 5 inches high

# 3. The Scan Loop
for row in range(GRID_SIZE):
    # Calculate Y position
    y_pos = row * STEP_MM
    
    # Logic for zigzag: if row is even, go 0->9. If odd, go 9->0.
    columns = range(GRID_SIZE) if row % 2 == 0 else reversed(range(GRID_SIZE))
    
    for col in columns:
        x_pos = col * STEP_MM
        
        # Move to coordinate
        print(f"Moving to Row {row}, Col {col} (X{x_pos}, Y{y_pos})")
        send_command(f"G1 X{x_pos} Y{y_pos} F3000")
        
        # 4. Pause and Trigger
        time.sleep(1.0) # Let vibrations settle
        
        # --- TRIGGER CAMERA HERE ---
        # If using a Pi Camera: camera.capture(f'img_{row}_{col}.jpg')
        print("ðŸ“¸ SNAP!") 

print("Scan Complete! Returning home.")
send_command("G28 X0 Y0") # Move back to start
