import serial
import time
import os
from picamera2 import Picamera2

# --- CONFIGURATION ---
PORT = '/dev/ttyUSB0'  # Ender 3 USB Port
STEP_MM = 12.7         # 0.5 inches
START_Z = 127.0        # 5 inches
GRID_SIZE = 10 

# --- CAMERA SETUP ---
picam2 = Picamera2()
config = picam2.create_still_configuration()
picam2.configure(config)
picam2.start()

# Create folder for images
folder_name = f"scan_{int(time.time())}"
os.makedirs(folder_name)

# --- PRINTER CONNECTION ---
try:
    printer = serial.Serial(PORT, 115200, timeout=1)
    time.sleep(2)
    print("Connected to Ender 3")
except:
    print("Printer connection failed.")
    exit()

def send_command(cmd):
    printer.write(f"{cmd}\n".encode())
    while True:
        line = printer.readline().decode().strip()
        if line == "ok":
            break

# 1. Homing & Setup
send_command("G28")
send_command(f"G1 Z{START_Z} F1500")

# 2. Grid Scan
for row in range(GRID_SIZE):
    y_pos = row * STEP_MM
    columns = range(GRID_SIZE) if row % 2 == 0 else reversed(range(GRID_SIZE))
    
    for col in columns:
        x_pos = col * STEP_MM

        # 1. TELL PRINTER TO MOVE
        send_command(f"G1 X{x_pos} Y{y_pos} F3000")

        # 2. THE PAUSE (Crucial for clear photos)
        # The script stops here and waits 1.5 seconds 
        # for the gantry to stop shaking.
        # Vibration settling time - crucial for long cables
        time.sleep(1.5) 
        
        # 3. Capture Image
        file_path = f"{folder_name}/x{col}_y{row}.jpg"
        picam2.capture_file(file_path)
        print(f"Captured point {col} in row {row} file: {file_path}")
       

picam2.stop()
send_command("G28 X0 Y0")
